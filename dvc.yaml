stages:
  extract-jhtdb-stats:
    cmd: python -c "import jhtdb; jhtdb.read_stats()"
    deps:
      - jhtdb.py
    outs:
      - data/jhtdb-transitional-bl/all-stats.h5
    desc: |
      Download statistics at various points in the flowfield. Note that this
      has already been run with make_stats(), so we don't rerun it here to
      not do this expensive step, which requires an access token for the
      JHTDB.
    meta:
      id: null
      output_type: dataset
  compute-coeffs:
    cmd: mkdir -p results && echo "{}" > results/coeffs.json
    deps:
      - data/jhtdb-transitional-bl/all-stats.h5
    outs:
      - results/coeffs.json
  build-sim-docker:
    cmd: cd sim && make docker
    deps:
      - sim/Dockerfile
  run-rans-sim:
    cmd: >
      mkdir -p sim/results
      && touch sim/results/time-ave-profile.csv
      && cd sim
      && make clean
      && make run-sim
    deps:
      - sim/Dockerfile
      - sim/system
      - results/coeffs.json
    outs:
      - sim/results/time-ave-profile.csv
  plot-time-ave-profiles:
    cmd: mkdir -p figures && touch figures/time-ave-profiles.pdf
    deps:
      - sim/results/time-ave-profile.csv
      - data/jhtdb-transitional-bl/time-ave-profiles.h5
    outs:
      - figures/time-ave-profiles.pdf
  plot-bl-dns:
    deps:
      - data/jhtdb-transitional-bl/all-stats.h5
      - scripts/plot-bl-dns.py
    cmd: python scripts/plot-bl-dns.py
    outs:
      - figures/bl-profile-dns.pdf
  build-paper:
    cmd: latexmk -pdf paper.tex
    wdir: paper
    deps:
      - paper.tex
      - ../figures/time-ave-profiles.pdf
      - ../figures/bl-profile-dns.pdf
      - ../references.bib
    outs:
      - paper.pdf

# TODO: Decide if this goes here or the ck dir
artifacts:
  dns-stats:
    path: data/jhtdb-transitional-bl/all-stats.h5
    type: dataset
    desc: This is a dataset.
    meta:
      title: Statistics computed at various points in the flowfield
  bl-dns-figure:
    path: figures/bl-profile-dns.pdf
    type: figure
    desc: Mean velocity profile.
    meta:
      title: Mean velocity profile
